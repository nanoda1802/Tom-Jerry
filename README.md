# Tom-Jerry

### 프로젝트 소개

> 불쌍한 톰이 오늘도 제리에게 쫓기고 있습니다!!
> 톰이 무사히 집으로 돌아갈 수 있도록 도와주세요!!

플레이어는 톰이 되어 쫓아오는 제리를 피해 도망가야 합니다!
도망치며 발견한 코인들을 통해 점수를 모아보세요!
하지만 톰의 앞길엔 이를 방해하는 작은 제리들이 등장합니다...
우연히 럭키 아이템을 얻는다면 이로운 효과를 얻을 수 있을지도 모릅니다!

- - -

### 발제 요구사항 가이드
1. 스테이지 구분
  - 스테이지는 총 5단계로 구성되며, 각 스테이지별로 요구 시간 달성 시 서버의 검증을 거쳐 다음 스테이지로 이동합니다!
  - stage-model 파일을 통해 서버에서도 스테이지 정보를 관리합니다!
2. 스테이지에 따른 점수 획득 구분
  - 스테이지 별로 등장하는 아이템이 특정돼있고, 높은 스테이지일수록 등장 아이템의 부여 점수가 높아집니다!
3. 스테이지에 따라 아이템이 생성
  - 2번 항목과 이하동문이며, item-unlock 데이터 테이블 대신, item 테이블에 stage 속성을 추가해 구분했습니다!
4. 아이템 획득 시 점수 획득
  - 아이템과 충돌 시 서버에 관련 정보를 보내고, 서버의 검증을 거쳐 유효할 시 점수를 획득합니다!
  - item-model 파일을 통해 서버에서도 획득 정보를 관리합니다!
5. 아이템 별 획득 점수 구분
  - 3번, 4번 항목과 이하동문이며, item 테이블의 score 속성을 통해 차등을 두었습니다!
6. Broadcast 기능 추가
  - 게임 종료 시 만약 서버 최고 기록이 갱신된 경우, 응답에 broadcast 속성을 추가해 모든 접속자에게 알림이 가도록 구현했습니다!
7. 가장 높은 점수 Record 관리
  - 게임 종료 시 일련의 검증을 거쳐 유효한 최고 기록인 경우, 서버에 저장하고, 이를 게임 시작 시 보내는 패킷을 활용해 클라이언트 화면에서 최신화되도록 했습니다!
  - high-score-model 파일을 통해 서버에서 최고 기록을 관리합니다!
8. 유저 정보 연결
  - localStorage에 uuid를 저장하도록 하여, 접속 시 uuid가 없으면 발급, 있다면 기존 것 사용하도록 해 유저를 식별하도록 했습니다!
  - 만약 확인한 uuid가 최고 기록 보유자의 것이면, 접속 시 특정 응답이 가도록 구현 했습니다! (최고기록 달성 후 새로고침 시 개발자 도구에서 확인 가능)
9. ~~Redis~~

---

### 조작 및 설명

1. 스페이스키를 누르면 톰이 점프합니다. 장애물을 피하며 최대한 많은 코인을 모아보세요!
2. ~~작은 제리들 중엔 튀어오르는 녀석들도 있습니다!! 갑작스레 충돌하지 않도록 주의하세요!~~
3. 코인을 먹으며 점수를 모아보세요! 코인의 점수는 스테이지에 비례해 증가합니다!
4. 럭키아이템인 별을 활용해보세요! 일정 시간 동안 장애물 충돌을 무시합니다!
5. 작은 제리들과 충돌할 시 게임 오버 입니다!!

---

### 디렉토리 구성

디렉토리는 크게 `assets`, `public`, `src`로 구성됩니다.

- **assets**
  - 게임에 필요한 재료 데이터들을 json 객체 형태로 보관하는 디렉토리
- **public**
  - 클라이언트 환경에서 필요한 html, css, script 파일 및 이미지 파일 등을 보관하는 디렉토리
- **src**
  - 서버 환경에서 필요한 앱, 핸들러, 시작파일, 모델 등을 보관하는 디렉토리

---

### 기능 설명

1. models

- user-model과 stage-model은 강의와 동일
- **item-model** : `{ A의 ID : [A의 아이템 획득 정보], B의 ID : [B의 아이템 획득 정보], ...}` 형태로 관리
  - createItems / setItems / getItems(전체 획득 조회) / getCoins(코인 획득만 조회) / getStars(스타 획득만 조회) / clearItems
- **high-score-model** : `{ 최고기록보유자의 ID : ??? , 최고점수 : ??? }` 형태로 관리
  - setHigh / getHigh

2. handlers

- **register-handler**
  - 해당 유저 접속자 목록에 추가 (`addUser` 함수 실행)
  - connection 메세지 emit (`handleConnection` 함수 실행)
  - 최고 기록 보유자인 경우 특수 메세지 emit
  - event 메세지 on (`handlerEvent` 함수 실행)
  - disconnect 메세지 on (`handleDisconnect` 함수 실행)
- **helper**
  - handleDisconnect : 해당 접속자 목록에서 제거 (`removeUser` 함수 실행)
  - handleConnect : 서버에서 유저 스테이지 정보 세팅하고, uuid 관리, 서버에서 로드한 assets 데이터들을 response 메세지로 보내줌
  - handleEvent : 핸들러 id를 판별해서 이에 맞는 함수로 연결시켜줌, 함수에 맞는 status 및 정보 반환
- **game-handler**
  - gameEnd
    - [검증 1] 이론상 획득 가능한 최대 점수를 초과하진 않는지
    - [검증 2] 서버에서 계산한 총점과 일치하는지
    - [검증 3] 클리어일 시 플레이 시간이 총 시간과 비교해서 적절한지
    - 하이스코어 갱신
  - gameStart : 서버에서 유저의 stage와 item 정보 초기화, 클라 갱신 위해 하이스코어 보내줌
- **stage-handler**
  - [검증 1] 서버에 저장된 최근 스테이지 ID와, 클라이언트가 보낸 현재 스테이지 ID가 동일한지 비교
  - [검증 2] 서버에 저장된 스테이지 변경 시간과 요청 받은 시간 비교해 경과 시간 계산, 임의로 설정한 오차 시간과 비교
  - [검증 3] 클라이언트가 목표한 다음 스테이지 정보의 ID가 서버 재료 데이터에 없으면 실패 응답
  - 모든 검증 통과 시 사용자의 스테이지를 다음으로 이동시키고, 이동 시간 기록
- **item-handler**
  - [검증 1] 획득 스테이지가 적합한지 검증
  - [검증 2] 획득 점수가 적합한지 검증
  - [검증 3] 획득 주기가 적합한지 검증 (두번째 획득부터 검사!!) (프레임 차이 고려해서 오차 0.3초 정도)
  - 검증 통과 시 클라에 응답 보내고, 성공일 때만 클라에서 점수 획득

---

### 기능 구현 리스트

- **공통**
  - [x] _<241217 AM12>_ 상수로 구현된 부분들 데이터테이블에서 참조하도록 수정
  - [x] _<241218 PM16>_ item_unlock.json 파일 제거 및 관련 코드 삭제 -> item 테이블에서 stage 필드 추가해 대체
  - [x] _<241219 PM17>_ handleDisconnect 확인, 이거 왜 undefined 뜨고 있지요????
  - [x] _<241219 PM17>_ 유저 정보 연결 구현 (localStorage에 발급받은 uuid 저장해 이미 id가 있으면 새 발급 안 하도록)
  - [ ] 리팩토링 및 주석 정리
- **점수**
  - [x] _<241213 PM15>_ 시간 비례 증가 X, 코인 획득 증가 O
  - 하이스코어 갱신 방법 변경
    - [x] _<241218 PM18>_ highScore 기록할 모델 파일 및 get, set 함수 구현
    - [x] _<241218 PM18>_ gameEnd 핸들러에서 검증 끝난 점수가 만약 갱신 가능하면 highScore 갱신하고 broadcast
    - [x] ~~_<241218 PM18>_ connection 메세지로 highScore 보내주고, 게임 시작 때 클라에서 적용되도록~~
    - [x] _<241219 PM17>_ gameStart에 대한 응답으로 현재 highScore를 받아 적용해주도록 변경 (기존 방법이면 재시작 시 화면에 적용 안됨)
    - [ ] 서버 종료 시 초기화됨 -> 레디스 적용........?
  - gameEnd() 함수 점수 검증 로직 최적화
    - [x] _<241218 PM16>_ 이론상 획득 가능한 최대 점수를 초과하진 않는지
    - [x] _<241218 PM16>_ 서버에서 계산한 총점과 일치하는지 (점수 획득 로직이 바뀌어서 조정해야함)
    - [x] _<241218 PM16>_ 클리어일 시 플레이 시간이 총 시간과 비교해서 적절한지
    - [x] _<241218 PM16>_ 검증 실패 시 하이스코어 갱신 X
- **스테이지**
  - [x] _<241213 PM15>_ 1단계 시작, 최대 5단계, 5단계 종료 시 게임 클리어
  - [x] _<241213 PM15>_ 시간 경과에 따른 스테이지 승급
  - [x] _<241213 PM15>_ 화면 상단 중앙에 현재 스테이지 텍스트 표시 `Stage N`
  - [x] _<241217 AM12>_ 스테이지 별 속도 차등화
  - 스테이지 승급 관련 서버 검증 프로세스
- **플레이어**
  - [x] _<241213 AM11>_ 기본 위치 조정
- **장애물**
  - [x] _<241213 AM11>_ 기본 위치 조정
  - [ ] 유형 개편 -> 점프 제리, 그냥 제리
- **보스**
  - [x] _<241213 AM11>_ `Boss` 클래스 모듈 생성
  - [x] _<241213 AM11>_ index.js에 관련 설정 추가
- **아이템**
  - [x] _<241213 AM11>_ 점수 획득 위한 코인 `Coin` 구현
  - [x] _<241213 PM18>_ `Coin`은 스테이지에 비례해 획득 점수 UP
  - [x] _<241213 PM18>_ 코인 등장 y값 최적화
  - [x] _<241213 AM11>_ 럭키 아이템 별 `Star` 구현
  - [x] _<241213 PM18>_ `Star`와 충돌 시 점수 대량 획득
  - [x] _<241213 PM20>_ `Star`와 충돌 시 일정 프레임 동안 장애물 충돌 무시
  - 아이템 공통 서버 검증 프로세스
    - [x] _<241217 PM16>_ 획득 점수가 아이템 별 점수와 일치하는지
    - [x] _<241217 PM16>_ 획득 주기가 생성 주기와 비교해서 적절한지
    - [x] 검증 실패 시 점수 획득 X
  - 코인 획득 관련 서버 검증 프로세스
    - [x] _<241217 PM16>_ 획득 아이템이 획득 스테이지에 적합한지
  - ~~별 획득 관련 서버 검증 프로세스~~
    - [ ] ~~효과 유지 프레임이 데이터 테이블의 정보와 비교해서 적절한지~~
    - [ ] ~~검증 실패 시 효과 즉시 종료~~
- **채팅**
  - [ ] 관전자가 있어서 보면서 채팅치며 소통할 수 있는?!
